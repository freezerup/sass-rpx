<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>three.js进行场景布置</title>
    <script src="./libs/three.js"></script>
    <script src="./libs/stats.js"></script>
    <script src="./libs/dat.gui.js"></script>
    <script src="./libs/OrbitControls.js"></script>
    <style>
      body { margin: 0; }
      canvas { width: 100%; height: 100% }
      .loading-box {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 99999;
        background: rgba(0,0,0);
      }
      .loading-img {
        position: absolute;
        top: 50%;
        left: 50%;
        margin-top: -50px;
        margin-left: -100px;
        width: 200px;
        height: 10px;
        border-radius: 10px;
        background: #fff;
        overflow: hidden;
      }
      .progress {
        width: 0;
        height: 100%;
        background: #ff5411;
      }
    </style>
</head>
<body onload="init()">
  <div id="canvas"></div>
  <div id="stats"></div>
  <div id="loading" class="loading-box">
    <div class="loading-img">
      <div id="progress" class="progress"></div>
    </div>
  </div>
<script>
  function initStats(type) {
    const panelType = (typeof type !== 'undefined' && type) && (isNaN(type)) ? parseInt(type) : 0;
    const stats = new Stats();
    stats.showPanel(panelType); // 0:fps; 1:ms; 3+:custom
    document.getElementById("stats").appendChild(stats.domElement);
    return stats;
  }
</script>

<script>
  const guiOptions = function() {
    this.rollSpeed = 0.01;
  }
  function initGui() {
    const options = new guiOptions();
    const gui = new dat.GUI();
    return options
  }
</script>

<script>
  let scene, renderer, camera
  const canvas = document.getElementById('canvas')
  const loading = document.getElementById('loading')
  const progress = document.getElementById('progress')
  function init() {
    const guiOptions = initGui();
    const stats = initStats();
    // 场景
    scene = new THREE.Scene();

    // 渲染器
    renderer = new THREE.WebGLRenderer();
    renderer.setClearColor(new THREE.Color(0xffffff, 1.0));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    // 摄像机 
    camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000)

    // 添加物体
    const sphere = createSphere();
    scene.add( sphere );
    const loader = new addFile()
    scene.add( loader );

    // 进度管理器
    createLoadingManager()

    camera.position.set(-30, 40, 30)
    camera.lookAt(scene.position)
    // 控制器
    const orbitControls = new THREE.OrbitControls(camera);
    orbitControls.autoRotate = false; // 是否自动旋转

    const clock = new THREE.Clock();
    // 添加光源
    scene.add(createAmbienLight()); // 基础光源

    canvas.appendChild( renderer.domElement );
    renderScene();
    function renderScene() {
      stats.update();
      const delta = clock.getDelta();
      orbitControls.update(delta);
      sphereAnimation(sphere, guiOptions);
      requestAnimationFrame(renderScene);
      renderer.render(scene, camera);
    }
  }

  // 添加加载管理器
  function createLoadingManager() {
    THREE.DefaultLoadingManager.onStart = function () {
      loading.style.display = 'block'
    }
    THREE.DefaultLoadingManager.onProgress = function ( url, itemsLoaded, itemsTotal ) {
      progress.style.width = `${(itemsLoaded/itemsTotal * 100)}%`
    };
    THREE.DefaultLoadingManager.onLoad = function () {
      loading.style.display = 'none'
    }
  }

  // 添加加载管理器
  function createManager() {
    const manager = new THREE.LoadingManager()
    manager.onStart = function(url, itemsLoaded, itemsTotal) {
      console.log('onStart', url, itemsLoaded, itemsTotal)
    }
    manager.onProgress = function(url, itemsLoaded, itemsTotal) {
      console.log('onProgress', url, itemsLoaded, itemsTotal)
    }
    manager.onError = function(url) {
      console.log('onError', url)
    }
    manager.onLoad = function() {
      console.log('onLoad')
    }
    return manager
  }


  function createSphere() {
    const map = 'https://image-static.segmentfault.com/325/115/3251155741-5ae9483989f3b';
    const geometry = new THREE.SphereGeometry( 10, 20, 20 );
    const texture = new THREE.TextureLoader(createManager());
    const material = new THREE.MeshBasicMaterial({ 
      map: texture.load(map),
     });
    const sphere = new THREE.Mesh( geometry, material );
    return sphere
  }

  function addFile() {
    const loader = new THREE.FileLoader();

    //加载一个文本文件，并把结果输出到控制台上
    loader.load(
      // resource URL
      'https://cdn.bootcss.com/three.js/r83/three.js',
      // onLoad回调
      function ( data ) {
        // output the text to the console
        console.log( data )
      },
      // onProgress回调
      function ( xhr ) {
        console.log( (xhr.loaded / xhr.total * 100) + '% loaded' );
      },
      // onError回调
      function ( err ) {
        console.error( 'An error happened' );
      }
    );
    return loader
  }

  function sphereAnimation(sphere, options) {
    sphere.rotation.y = (sphere.rotation.y + options.rollSpeed) % (Math.PI * 2);
  }

  // 光源
  function createAmbienLight() {
    const ambienLight = new THREE.AmbientLight(0xffffff);
    return ambienLight
  }


  // 监听屏幕变化
  function onResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  }
  window.addEventListener('resize', onResize, false);

</script>
</body>
</html>